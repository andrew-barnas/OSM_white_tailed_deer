filter(row_number()==1)%>%
ungroup()
#Lets add in the site coordinates
wtd_spatial<-merge(
#The camera file with locations
camop%>%
select(site, lat, long),
#summary of detections
wtd_ind%>%
group_by(site)%>%
summarise(n_events = n()),
by = c("site"), all.x = TRUE)%>%
mutate(n_events = ifelse(is.na(n_events), 0, n_events))
ggplot() +
geom_sf(data = canada, fill = "gray95", color = "gray70") +
geom_point(data = wtd_spatial,
aes(x = long, y = lat, color = n_events, size = n_events)) +
scale_color_viridis_c(option = "plasma") +
coord_sf(xlim = range(wtd_ind$long) + c(-0.1, 0.1),
ylim = range(wtd_ind$lat) + c(-0.1, 0.1),
expand = FALSE) +
theme_minimal() +
labs(
x = "Longitude",
y = "Latitude",
title = "Wildlife detection events per site",
color = "Number of events",
size = "Number of events"
)
# Note: This is a critical step to make a decision on how we filter this - don't want to loose data by just taking first row when there are multiple rows of data in a detection? Just want to sum? take highest? THINK SYD
wtd_ind<-wtd %>%
group_by(Event.ID) %>%
filter(row_number()==1)%>%
ungroup()
#Lets add in the site coordinates
wtd_spatial<-merge(
#The camera file with locations
camop%>%
select(site, lat, long),
#summary of detections
wtd_ind%>%
group_by(site)%>%
summarise(n_events = n()),
by = c("site"), all.x = TRUE)%>%
mutate(n_events = ifelse(is.na(n_events), 0, n_events))
ggplot() +
geom_sf(data = canada, fill = "gray95", color = "gray70") +
geom_point(data = wtd_spatial,
aes(x = long, y = lat, color = n_events, size = n_events)) +
scale_color_viridis_c(option = "plasma") +
coord_sf(xlim = range(wtd_ind$long) + c(-0.1, 0.1),
ylim = range(wtd_ind$lat) + c(-0.1, 0.1),
expand = FALSE) +
theme_minimal() +
labs(
x = "Longitude",
y = "Latitude",
title = "Wildlife detection events per site",
color = "Number of events",
size = "Number of events"
)
View(wtd_spatial)
ggplot() +
geom_sf(data = canada, fill = "gray95", color = "gray70") +
geom_point(data = wtd_spatial,
aes(x = long, y = lat, color = n_events, size = n_events)) +
scale_color_viridis_c(option = "plasma") +
coord_sf(xlim = range(wtd_spatial$long) + c(-0.1, 0.1),
ylim = range(wtd_spatial$lat) + c(-0.1, 0.1),
expand = FALSE) +
theme_minimal() +
labs(
x = "Longitude",
y = "Latitude",
title = "Wildlife detection events per site",
color = "Number of events",
size = "Number of events"
)
#What about a plot over time of year? Or by year?
wtd_ind
View(wtd_ind)
mutate(n_events = ifelse(is.na(n_events), 0, n_events))
wtd_ind%>%
mutate(month = month(datetime),
year = year(datetime))%>%
group_by(year, month, site)%>%
summarise(n_events = n())
wtd_ind%>%
mutate(month = month(datetime),
year = year(datetime))%>%
group_by(year, month, site)%>%
summarise(n_events = n()),
#What about a plot over time of year? Or by year?
wtd_ind%>%
mutate(month = month(datetime),
year = year(datetime))%>%
group_by(year, month, site)%>%
summarise(n_events = n())%>%
mutate(n_events = ifelse(is.na(n_events), 0, n_events))
#What about a plot over time of year? Or by year?
wtd_ind%>%
mutate(month = month(datetime),
year = year(datetime))%>%
group_by(year, month, site)%>%
summarise(n_events = n())%>%
mutate(n_events = ifelse(is.na(n_events), 0, n_events))%>%
ggplot(aes(x = n_events))+
geom_histogram()
#What about a plot over time of year? Or by year?
wtd_ind%>%
mutate(month = month(datetime),
year = year(datetime))%>%
group_by(year, month, site)%>%
summarise(n_events = n())%>%
mutate(n_events = ifelse(is.na(n_events), 0, n_events))%>%
ggplot(aes(, x = month, y = n_events))+
geom_bar(stat= "identity")
#What about a plot over time of year? Or by year?
wtd_ind%>%
mutate(month = month(datetime),
year = year(datetime))%>%
group_by(year, month, site)%>%
summarise(n_events = n())%>%
mutate(n_events = ifelse(is.na(n_events), 0, n_events))%>%
ggplot(aes(, x = as.factor(month), y = n_events))+
geom_bar(stat= "identity")+
face
#What about a plot over time of year? Or by year?
wtd_ind%>%
mutate(month = month(datetime),
year = year(datetime))%>%
group_by(year, month, site)%>%
summarise(n_events = n())%>%
mutate(n_events = ifelse(is.na(n_events), 0, n_events))%>%
ggplot(aes(, x = as.factor(month), y = n_events))+
geom_bar(stat= "identity")+
facet_wrap(~year)
#What about a plot over time of year? Or by year?
wtd_ind%>%
mutate(month = month(datetime),
year = year(datetime))%>%
group_by(year, month, site)%>%
summarise(n_events = n())%>%
mutate(n_events = ifelse(is.na(n_events), 0, n_events))%>%
ggplot(aes(, x = as.factor(month), y = n_events))+
geom_bar(stat= "identity")+
facet_wrap(~year, nrow = 1)
wtd_ind%>%
mutate(month = month(datetime),
year = year(datetime))%>%
group_by(year, month, site)%>%
summarise(n_events = n())%>%
mutate(n_events = ifelse(is.na(n_events), 0, n_events))
View(wtd)
#So this is a frame of wtd and the independent detecitons
wtd
View(wtd_ind)
#Lets filter it down to just look at known females and yoy
wtd%>%
select(array, site, datetime, female, yoy, Event.ID)
#Lets filter it down to just look at known females and yoy
df<-wtd%>%
select(array, site, datetime, female, yoy, Event.ID)
if_else()
?if(else)
?if_else()
#Second, since we don't care about numbers, we are going to turn things into binary present or absent. And NAs to zero
df <- df %>%
mutate(across(c(female, yoy),
~ ifelse(is.na(.x) | .x == 0, 0, 1)))
df
df %>%
group_by(Event.ID) %>%
mutate(
# Whether any yoy = 1 within the event
yoy_present = as.integer(any(yoy == 1, na.rm = TRUE)),
# Whether ONLY females were present (female = 1 somewhere, but no yoy = 1 anywhere)
female_only = as.integer(any(female == 1, na.rm = TRUE) & !any(yoy == 1, na.rm = TRUE))
) %>%
ungroup()
df<-df %>%
group_by(Event.ID) %>%
mutate(
# Whether any yoy = 1 within the event
yoy_present = as.integer(any(yoy == 1, na.rm = TRUE)),
# Whether ONLY females were present (female = 1 somewhere, but no yoy = 1 anywhere)
female_only = as.integer(any(female == 1, na.rm = TRUE) & !any(yoy == 1, na.rm = TRUE))
) %>%
ungroup()
View(df)
#Reduce to one observation per event, and filter out events that featured neither
df%>%
group_by(Event.ID)%>%
filter(row_number()==1)
#Reduce to one observation per event, and filter out events that featured neither
df%>%
group_by(Event.ID)%>%
filter(row_number()==1)%>%
filter(!(yoy_present == 0 & female_only == 0))
#Reduce to one observation per event, and filter out events that featured neither
df<-df%>%
group_by(Event.ID)%>%
filter(row_number()==1)%>%
filter(!(yoy_present == 0 & female_only == 0))
#Just females
df%>%
filter(female_only > 0)%>%
summarise(n_events = n_row(df))
#Just females
df%>%
filter(female_only > 0)%>%
summarise(n_events = n())
#Lets filter it down to just look at known females and yoy
df<-wtd%>%
select(array, site, datetime, female, yoy, Event.ID)
#Second, since we don't care about numbers, we are going to turn things into binary present or absent. And NAs to zero
df <- df %>%
mutate(across(c(female, yoy),
~ ifelse(is.na(.x) | .x == 0, 0, 1)))
df<-df %>%
group_by(Event.ID) %>%
mutate(
# Whether any yoy = 1 within the event
yoy_present = as.integer(any(yoy == 1, na.rm = TRUE)),
# Whether ONLY females were present (female = 1 somewhere, but no yoy = 1 anywhere)
female_only = as.integer(any(female == 1, na.rm = TRUE) & !any(yoy == 1, na.rm = TRUE))
) %>%
ungroup()
#Reduce to one observation per event, and filter out events that featured neither
df<-df%>%
group_by(Event.ID)%>%
filter(row_number()==1)%>%
filter(!(yoy_present == 0 & female_only == 0))%>%
ungroup()
#Just females
df%>%
filter(female_only > 0)%>%
summarise(n_events = n())
females_only<-df%>%
filter(female_only > 0)
#So this is a frame of wtd and the independent detecitons
wtd
#Lets filter it down to just look at known females and yoy
df<-wtd%>%
select(array, site, datetime, female, yoy, Event.ID)
#Second, since we don't care about numbers, we are going to turn things into binary present or absent. And NAs to zero
df <- df %>%
mutate(across(c(female, yoy),
~ ifelse(is.na(.x) | .x == 0, 0, 1)))
df<-df %>%
group_by(Event.ID) %>%
mutate(
# Whether any yoy = 1 within the event
yoy_present = as.integer(any(yoy == 1, na.rm = TRUE)),
# Whether ONLY females were present (female = 1 somewhere, but no yoy = 1 anywhere)
female_only = as.integer(any(female == 1, na.rm = TRUE) & !any(yoy == 1, na.rm = TRUE))
) %>%
ungroup()
#Reduce to one observation per event, and filter out events that featured neither
df<-df%>%
group_by(Event.ID)%>%
filter(row_number()==1)%>%
filter(!(yoy_present == 0 & female_only == 0))%>%
ungroup()
#Just females
df%>%
filter(female_only > 0)%>%
summarise(n_events = n())
females_only<-df%>%
filter(female_only > 0)
n_distinct(females_only$array)
n_distinct(females_only$site)
289/430
fawns<-df%>%
filter(yoy_present > 0)
nrow(fawns)
n_distinct(fawns$array)
n_distinct(fawns$site)
149/430
View(df)
females_only%>%
group_by(site)%>%
summarise(n_events = n())
#Lets map them
#Dont forget to join in the coordinates
females_spatial<-merge(
#The camera file with locations
camop%>%
select(site, lat, long),
#summary of detections
females_only%>%
group_by(site)%>%
summarise(n_events = n()),
by = c("site"), all.x = TRUE)%>%
mutate(n_events = ifelse(is.na(n_events), 0, n_events))
ggplot() +
geom_sf(data = canada, fill = "gray95", color = "gray70") +
geom_point(data = females_spatial,
aes(x = long, y = lat, color = n_events, size = n_events)) +
scale_color_viridis_c(option = "plasma") +
coord_sf(xlim = range(females_spatial$long) + c(-0.1, 0.1),
ylim = range(females_spatial$lat) + c(-0.1, 0.1),
expand = FALSE) +
theme_minimal() +
labs(
x = "Longitude",
y = "Latitude",
title = "Female only detections",
color = "Number of events",
size = "Number of events"
)
fawns_spatial<-merge(
#The camera file with locations
camop%>%
select(site, lat, long),
#summary of detections
fawns%>%
group_by(site)%>%
summarise(n_events = n()),
by = c("site"), all.x = TRUE)%>%
mutate(n_events = ifelse(is.na(n_events), 0, n_events))
ggplot() +
geom_sf(data = canada, fill = "gray95", color = "gray70") +
geom_point(data = fawns_spatial,
aes(x = long, y = lat, color = n_events, size = n_events)) +
scale_color_viridis_c(option = "plasma") +
coord_sf(xlim = range(fawns_spatial$long) + c(-0.1, 0.1),
ylim = range(fawns_spatial$lat) + c(-0.1, 0.1),
expand = FALSE) +
theme_minimal() +
labs(
x = "Longitude",
y = "Latitude",
title = "Female only detections",
color = "Number of events",
size = "Number of events"
)
430*12
5160*0.6
3096/100
5160*15
77400/1000
View(covs)
View(fawns_spatial)
colnames(covs)
#Ok lets work on the covariates. I am just going to make a broad disturbance index for each site
#at 1000m reflecting the camera spacing
covs%>%
filter(buff_dist == 1000)%>%
#remove the habitat classifications
select(-c(lc_class110, lc_class120, lc_class20, lc_class210, lc_class220, lc_class230, lc_class32, lc_class33, lc_class34, lc_class50))
#Ok lets work on the covariates. I am just going to make a broad disturbance index for each site
#at 1000m reflecting the camera spacing
covs<-covs%>%
filter(buff_dist == 1000)%>%
#remove the habitat classifications
select(-c(lc_class110, lc_class120, lc_class20, lc_class210, lc_class220, lc_class230, lc_class32, lc_class33, lc_class34, lc_class50))
View(covs)
#Create a sum across columns 4 to 50
covs%>%
mutate(disturbance_index = rowsum(4:50))
mutate(disturbance_index = rowSums(across(4:50))
#Create a sum across columns 4 to 50
covs%>%
mutate(disturbance_index = rowSums(across(4:50))
covs%>%
#Create a sum across columns 4 to 50
covs%>%
mutate(disturbance_index = rowSums(across(4:50)))
#Create a sum across columns 4 to 50
covs<-covs%>%
mutate(disturbance_index = rowSums(across(4:50)))%>%
select(array, site, disturbance_index)
ggplot(covs, aes(x = disturbance_index))+
geom_histogram()+
facet_wrap(~array)
#Ok now link that into the detection files
merge(covs, females_spatial, by = c"site")
#Ok now link that into the detection files
merge(covs, females_spatial, by = c("site")
#Ok now link that into the detection files
females_spatial<-merge(covs, females_spatial, by = c("site")
View(females_spatial)
#Ok now link that into the detection files
females_spatial<-merge(covs, females_spatial, by = c("site"))
fawns_spatial<-merge(covs, fawns_spatial, by = c("site"))
View(fawns_spatial)
#This is stupid lets make this into one frame
females_spatial%>%rename(females = n_events)
#This is stupid lets make this into one frame
females_spatial%>%rename(females = n_events)
fawns_spatial%>%rename(yoy = n_events)
#This is stupid lets make this into one frame
merge(females_spatial%>%rename(females = n_events),
fawns_spatial%>%rename(yoy = n_events))
#This is stupid lets make this into one frame
df<-merge(females_spatial%>%rename(females = n_events),
fawns_spatial%>%rename(yoy = n_events))
ggplot(df, aes(x = disturbance_index, y = females, color = array))+
geom_point()
ggplot(df, aes(x = disturbance_index, y = females, color = array))+
geom_point(size = 4)+
ylab("Female detecionts")
ggplot(df, aes(x = disturbance_index, y = females, color = array))+
geom_point(size = 3)+
ylab("Female detecionts")
ggplot(df, aes(x = disturbance_index, y = females, color = array))+
geom_point(size = 3)+
ylab("Female detections")+
xlab("Disturbance index")
ggplot(df, aes(x = disturbance_index, y = yoy, color = array))+
geom_point(size = 3)+
ylab("YOY detections")+
xlab("Disturbance index")
ggplot(df, aes(x = disturbance_index, y = females, color = array))+
geom_point(size = 3)+
ylab("Female detections")+
xlab("Disturbance index")+
ggtitle("Females ~ disturbance")
ggplot(df, aes(x = disturbance_index, y = yoy, color = array))+
geom_point(size = 3)+
ylab("YOY detections")+
xlab("Disturbance index")+
ggtitle("Fawns ~ disturbance")
log(0)
#A couple quick data transformations
hist(df$females)
View(camop)
summary(df$females)
#Quick models
glmmTMB::glmmTMB(females ~ disturbance_index + (1|array),
family = poisson,
data = df)
#Quick models
m1<-glmmTMB::glmmTMB(females ~ disturbance_index + (1|array),
family = poisson,
data = df)
summary(m1)
#Quick models
m2<-glmmTMB::glmmTMB(fawns ~ disturbance_index + (1|array),
family = poisson,
data = df)
#Quick models
m2<-glmmTMB::glmmTMB(yoy ~ disturbance_index + (1|array),
family = poisson,
data = df)
summary(m2)
install.packages("segmented")
library(segmented)
# Start with a regular linear model (use log if counts are highly skewed)
lm_base <- lm(yoy ~ disturbance_index, data = df)
# Fit a segmented model with an estimated breakpoint
seg_fit <- segmented(lm_base, seg.Z = ~disturbance_index)
summary(seg_fit)
# Get the breakpoint
bp <- summary(seg_fit)$psi[1]
# Create predictions
newdat2 <- data.frame(disturbance_index = seq(min(df$disturbance_index),
max(df$disturbance_index),
length.out = 200))
newdat2$pred <- predict(seg_fit, newdata = newdat2)
# Plot
ggplot(df, aes(disturbance_index, yoy)) +
geom_point(alpha = 0.4) +
geom_line(data = newdat2, aes(y = pred), color = "firebrick", size = 1.2) +
geom_vline(xintercept = bp, linetype = "dashed", color = "gray40") +
annotate("text", x = bp, y = max(df$yoy, na.rm = TRUE),
label = paste("Breakpoint â‰ˆ", round(bp, 2)), vjust = -1) +
labs(x = "Disturbance index", y = "Fawn detections") +
theme_classic()
m2_quad <- glmmTMB(
yoy ~ disturbance_index + I(disturbance_index^2) + (1|array),
family = poisson,
data = df
)
m2_quad <- glmmTMB::glmmTMB(
yoy ~ disturbance_index + I(disturbance_index^2) + (1|array),
family = poisson,
data = df
)
summary(m2_quad)
newdat <- expand.grid(
disturbance_index = seq(min(df$disturbance_index, na.rm = TRUE),
max(df$disturbance_index, na.rm = TRUE),
length.out = 100),
array = NA  # average random effect
)
newdat$pred <- predict(m2_quad, newdata = newdat, type = "response", re.form = NA)
ggplot(newdat, aes(disturbance_index, pred)) +
geom_line(size = 1.2, color = "steelblue") +
labs(x = "Disturbance index", y = "Predicted fawn detections") +
theme_classic()
preds <- predict(m2_quad, newdata = newdat, type = "link", se.fit = TRUE, re.form = NA)
View(preds)
newdat <- newdat %>%
mutate(
fit_link = preds$fit,
se_link  = preds$se.fit,
fit_resp = exp(fit_link),
lower    = exp(fit_link - 1.96 * se_link),
upper    = exp(fit_link + 1.96 * se_link)
)
# Plot
ggplot(newdat, aes(x = disturbance_index, y = fit_resp)) +
geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2, fill = "steelblue") +
geom_line(color = "steelblue", size = 1.2) +
labs(
x = "Disturbance index",
y = "Predicted fawn detections",
title = "Quadratic relationship between disturbance and fawn detections"
) +
theme_classic()
