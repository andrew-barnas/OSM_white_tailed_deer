The purpose of this file is to do the setup of the response varible for deer? Lets do this clean. 


```{r}
#Clear everything out and start fresh
rm(list=ls())
library(reproducible) #setting up directories for data management
library(readr)        #Needed to read and merge all the csv's in the camera folder
library(dplyr)        #data wranglin'
library(lubridate)    #datetime manipulation
library(tidyr)        #more data manipulation
library(stringr)      #detecting character strings
library(ggplot2)      #data visualization
library(purrr)        #feline-friendly loops 
library(corrplot)     #correlation tests
library(factoextra)   #Principle Components Analysis
library(rgl)


#This just sets up files for inputs (already created, must contain your files), and outputs
input_directory<-reproducible::checkPath(file.path(getwd(), "1. Species Response Variables/outputs"), create = TRUE)
output_directory<-reproducible::checkPath(file.path(getwd(), "2. Site Variables/outputs"), create = TRUE)
figure_directory<-reproducible::checkPath(file.path(getwd(), "2. Site Variables/figures"), create = TRUE)


#read in the files we need
#This is from the species response variable file
wtd_dets<-read.csv(file.path(input_directory, "weekly_proportional_binomial.csv"))

#These are from the original input folder (fix later to be better)
camop<-read.csv(file.path(getwd(), "1. Species Response Variables/inputs/OSM_camera_deployment.csv"))
covs<-read.csv(file.path(getwd(), "1. Species Response Variables/inputs/OSM_camera_covariates.csv"))

#And the weather data (needs to update)
weather<-read.csv(file.path(getwd(), "1. Species Response Variables/inputs/daymet_weather_data.csv"))

#I am reading this in from the desktop since it is too large to push to github
weather_10<-read.csv("C:/Users/16043/Desktop/OSM white tailed deer/daymet_weather_data_10year.csv")


```




First thing I would like to do is construct a Principle Components Analysis of the habitat variables
```{r}


#First thing to do is to extract and rename the natural habitat variables from the dataframe
#Naming conventions are weird from the ABMI source, going to update based on common names

habitat<-covs%>%
  #Using 1000m buffer to match the weather variables 
  filter(buff_dist == 1000)%>%
  #Rename them variables
  dplyr::select(array, site,
                water = lc_class20,
                shrub = lc_class50,
                grassland = lc_class110,
                coniferous = lc_class210,
                broadleaf = lc_class220,
                mixed = lc_class230)%>%
  #And scale them all at once
  mutate(across(c(water, broadleaf, grassland, coniferous, mixed, shrub),
              .fns = ~ as.numeric(scale(.x))))


# Run PCA (center = FALSE, scale. = FALSE since theyre already scaled)
habitat_pca <- prcomp(habitat %>%
                        dplyr::select(water, broadleaf, grassland, coniferous, mixed, shrub),
                      center = FALSE, scale. = FALSE)

# Inspect PCA results - the cumulative proportion bascially tells you the variance explained by the cumulative addition of each principle component
summary(habitat_pca)
# Loadings (how variables contribute to PCs), basically as we move from each component how do habitats change?
habitat_pca$rotation
#E.g. PC1 broadleaf = 0.55, strong positive contribution, coniferous = -0.69 strong negative contribution
#PC1 represents a gradient between broadleaf and coniferous cover --> high PC1 more broadleaf less coniferous, low PC1 more coniferous, less broadleaf
#PC2 gradient from mixed to shrubby



# PCA scores for each site - these are the values we add back into the dataframe
head(habitat_pca$x)

# Combine PCA scores back with site info (use this to select PCs later)
habitat_pca_df <- bind_cols(
  habitat %>% dplyr::select(array, site),
  as.data.frame(habitat_pca$x)
)

# Quick visualization of the first two PCs
ggplot(habitat_pca_df, aes(x = PC1, y = PC2, color = array)) +
  geom_point(size = 3) +
  theme_minimal() +
  labs(title = "PCA of Habitat Variables",
       x = "PC1 (coniferous to broadleaf)", y = "PC2 (mixed to shrub)")


fviz_pca_biplot(habitat_pca,
                axes = c(1, 2),     # use first 2 
                label = "var",         # show variable loadings
                habillage = habitat$array,  # color by array
                addEllipses = TRUE, 
                repel = TRUE,
                geom.ind = "point") +
  ggtitle("3D PCA Biplot of Habitat Variables")


#Ok lets use PC1 and PC2 for now, lets put them into the main dataframe
#Might need to consider PC3s later
wtd_dets<-wtd_dets%>%
  left_join(habitat_pca_df%>%
              dplyr::select(array, site, PC1, PC2),
            by = c("array", "site"))

```

##############################################################################

Alright lets continue to work on our covariate file. I am going to keep things very simple for the time being. Just looking at a few 
```{r}
#I think I want to experiment with a few key ones, along with an overall habitat disturbance score
#Based off Marissas SEM results: 
#Positive: roads, wells (active), wells (inactive), timber harvest
#Negative: Seismic lines, 3d seismic lines, pipelines

#Lets pull those out
covs<-covs%>%
  filter(buff_dist == 1000)%>%
  relocate(array, site)%>%
  #remove the habitat classifications
  select(-c(lc_class110, lc_class120, lc_class20, lc_class210, lc_class230, lc_class32, lc_class33, lc_class34, lc_class50))


#Create a sum across columns 4 to 50, this will represent an overall disturbance score!
covs<-covs%>%
  mutate(disturbance_index = rowSums(across(5:50)))

#Ok now the specific ones
colnames(covs)

covs<-covs%>%
  #Lets put all the roads together
  mutate(roads = road_gravel_1l + road_gravel_2l + road_paved_1l + road_paved_2l + road_paved_3l + road_paved_4l + road_paved_5l + road_paved_div + road_paved_undiv_1l + road_paved_undiv_2l + road_unclassified + road_unimproved + road_unpaved_1l + road_unpaved_2l + road_winter,
         
  #and and active well thing?
  well_gas = well_gas,
  well_oil = well_oil,
  well_bitumen = well_bitumen,
  wells = well_gas + well_oil + well_bitumen,
  inactive_well = well_aband,
  seismic = conventional_seismic,
  seismic_3D = low_impact_seismic,
  harvest = harvest_area,
  pipeline = pipeline)%>%
  dplyr::select(array, site, disturbance_index, roads, wells, well_gas, well_oil, well_bitumen, inactive_well, seismic, seismic_3D, harvest, pipeline)

#Some very quick and dirty exploration
hist(covs$disturbance_index)
hist(covs$well_gas)
hist(covs$well_oil)
hist(covs$well_bitumen)
hist(covs$wells)
hist(covs$roads)
hist(covs$inactive_well)
hist(covs$seismic)
hist(covs$seismic_3D)  
hist(covs$harvest)
hist(covs$pipeline)       

#Recognize that we still ahve all our sites!
n_distinct(covs$site)



#Lets link that into the detection file
wtd_dets<-merge(wtd_dets, covs, by = c("site", "array"))


```

Weather data. Ok there are a few different things that need doing in this block. Going to keep it all simple and just work with snow for now. But I need to build:
1) RAW: For each site - the preceeding years mean snow data
2) AVERAGE TEMPORAL: for each site, the average mean snow within an array in the preceeding year
3) AVERAGE SPATIAL: for each site, the average mean snow for that site across the last 10 years
4) ANOMALY: for each site the difference between the current data - temporal and - spatial.
```{r}
#So first things first, lets keep life simple and just look at snow
weather_10<-weather_10%>%
  dplyr::select(c(site, latitude, longitude, year, day, snow = snow_water_equiv_kgM2), temp = min_temp_C)

#I would like a couple graphs here showing the time series for each variable
#First lets get the dates read in nicely
weather_10 <- weather_10 %>%
  mutate(date = ymd(paste0(year, "-01-01")) + days(day - 1))

weather_summary<-weather_10%>%
  group_by(date)%>%
  summarise(mean_snow = mean(snow),
            sd_snow = sd(snow))

#Snow Plot
ggplot(weather_summary, aes(x = date)) +
  geom_ribbon(
    aes(ymin = mean_snow - sd_snow,
        ymax = mean_snow + sd_snow),
    fill = "grey", alpha = 0.6
  ) +
  geom_line(aes(y = mean_snow), color = "black", size = 1) +
  ylab("Mean Snow Water Equivalent (kg)") +
  xlab("Date") +
  ggtitle("Daily Snow")+
  theme_classic()

######################################################################################
#Ok, lets get these measures into the dataframe. Now, we want to think about lag times and whatnot. So lets extract 

#First lets define the winter months (using guidance from Dickie et al which reports snow periods as Sep 1 to March 31) (Potentially rethink this since we use September data for fawns)
winter_months<-c(9, 10, 11, 12, 1, 2, 3) 


#First just keep data in those months
weather_10<-weather_10%>%
  filter(month(date) %in% winter_months)
  

#Ok ok. Now remember, the weather dataframe has data for all sites for all years. But we don't need that 
weather_summary <- weather_10 %>%
  # Extract month for filtering
  mutate(month = month(date),
         # Define "winter_year" = the year that the winter *starts*
         winter_year = if_else(month >= 9, year(date), year(date) - 1)) %>%
  
  # Group by site and winter season
  group_by(site, winter_year) %>%
  
  # Summarize mean and sd for each variable
  summarise(
    mean_snow  = mean(snow, na.rm = TRUE),
    mean_min_temp   = mean(temp, na.rm = TRUE),
    n_days    = n(),  # optional â€” good to check how many days were available
    .groups = "drop"
  )

#Ok so at this point I have the winter_year data for each site. Now I need to manipulate and decompose that data into what I need.

#First, lets get the raw data into the wtd_dets dataframe
#Identify the winter year to use
wtd_dets<-wtd_dets%>%
  mutate(winter_year = year - 1)

wtd_dets<-wtd_dets%>%
  left_join(weather_summary%>%
  dplyr::select(site, winter_year, mean_snow, mean_min_temp), 
  by = c("site", "winter_year"))

#make sure that worked- no NAs!
summary(wtd_dets$mean_snow)
hist(wtd_dets$mean_snow)
summary(wtd_dets$mean_min_temp)
hist(wtd_dets$mean_min_temp)

###########################################
#Ok now the temporal component. For each site/year what was the average winter snow across its respective array.
#To do this I will need to add array back into the weather data. My bad. I can get that from camop

weather_summary<-weather_summary%>%
  left_join(camop%>%
  dplyr::select(site, array),
  by = "site")%>%
  relocate(array, site)

#So this calculation is slightly different! Grouping by year to get an overall average!
weather_summary%>%
  group_by(winter_year)%>%
  summarise(mean_snow_temporal = mean(mean_snow),
            mean_min_temp_temporal = mean(mean_min_temp))


#join it all up
wtd_dets<-wtd_dets%>%
  left_join(
weather_summary%>%
  group_by(winter_year)%>%
  summarise(mean_snow_temporal = mean(mean_snow),
            mean_min_temp_temporal = mean(mean_min_temp)),
by = c("winter_year"))

###################################################################
#Average spatial - so now we are going to take a single site, and find the average over the last 10 years
head(weather_summary)

#This is slightly tricky though, because I need to find a date range for each site. I've got a rather clever idea. Lets take the winter year, and then calculate a min year 10 years before that
site_years<-wtd_dets%>%
  mutate(min_year = winter_year - 10)%>%
  dplyr::select(site, winter_year, min_year)

site_10_year_snow<-site_years %>%
  left_join(weather_summary, by = "site") %>%
  #determining which years to keep based on the winter years in both frames
   #keep weather summary winter year if its greater than the minimum for its site
   filter(winter_year.y >= min_year, 
         #keep weather summary winter year if its less than the max for its site  
         winter_year.y <= winter_year.x) %>%
  group_by(site, winter_year = winter_year.x) %>%
  summarise(mean_snow_spatial = mean(mean_snow, na.rm = TRUE),
            mean_min_temp_spatial = mean(mean_min_temp, na.rm = TRUE), .groups = "drop")

#And now we can join that in e z p z
wtd_dets<-wtd_dets%>%
  left_join(site_10_year_snow, by = c("site", "winter_year"))

############################################################################
#Winter anomaly!

#This one should be easier I think to calculate as I am pretty sure it is just the difference between the raw and the time minus space
wtd_dets<-wtd_dets%>%
  mutate(snow_anomaly = mean_snow - mean_snow_spatial,
         temp_anomaly = mean_min_temp - mean_min_temp_spatial)

hist(wtd_dets$snow_anomaly)
hist(wtd_dets$temp_anomaly)


#Lets write that file and move on to modeling!
write.csv(wtd_dets, file.path(output_directory, "final_df.csv"),
          row.names = FALSE)


```

Lets do a little exercise here, I want to know how these different disturbance metrics are performing
```{r}
#How do I keep losing lat/long??
wtd_dets<-wtd_dets%>%
  left_join(camop%>%
              dplyr::select(site, lat, long),
            by = "site")


#Scale everyone
wtd_dets<-wtd_dets%>%
  mutate(across(c(mean_snow, mean_snow_spatial, snow_anomaly, mean_min_temp, mean_min_temp_spatial, temp_anomaly, disturbance_index, broadleaf, lat, roads, well_gas, well_oil, well_bitumen, inactive_well, seismic, seismic_3D, harvest, pipeline),
              .fns = ~ as.numeric(scale(.x))))  


#Model of the PCs
m1<-glmmTMB::glmmTMB(cbind(deer_present, (n_weeks - deer_present)) ~
                   PC1 + PC2+
                   (1|array),
                 family = "binomial",
                 data = wtd_dets)

summary(m1)


#How does a model behave with broadleaf vs these components
broadleaf_model<-glmmTMB::glmmTMB(cbind(deer_present, (n_weeks - deer_present)) ~
                   broadleaf+
                   (1|array),
                 family = "binomial",
                 data = wtd_dets)
summary(broadleaf_model)




pc_model<-glmmTMB::glmmTMB(cbind(deer_present, (n_weeks - deer_present)) ~
                   PC1 + PC2+
                   (1|array),
                 family = "binomial",
                 data = wtd_dets)

summary(pc_model)

model.sel(broadleaf_model, pc_model, rank = "AICc")


#Global model of disturbance stuff
m1<-glmmTMB::glmmTMB(cbind(deer_present, (n_weeks - deer_present)) ~
                   disturbance_index + roads + well_gas + well_oil + well_bitumen + inactive_well + seismic + seismic_3D + harvest + pipeline+ 
                   (1|array),
                 family = "binomial",
                 data = wtd_dets)

summary(m1)


#Quick model seleciton exercise?
disturbance_index<-glmmTMB::glmmTMB(cbind(deer_present, (n_weeks - deer_present)) ~
                   disturbance_index +
                   (1|array),
                 family = "binomial",
                 data = wtd_dets)

summary(disturbance_index)
roads<-glmmTMB::glmmTMB(cbind(deer_present, (n_weeks - deer_present)) ~
                   roads +
                   (1|array),
                 family = "binomial",
                 data = wtd_dets)

summary(roads)
well_gas<-glmmTMB::glmmTMB(cbind(deer_present, (n_weeks - deer_present)) ~
                   well_gas +
                   (1|array),
                 family = "binomial",
                 data = wtd_dets)

summary(well_gas)

well_bitumen<-glmmTMB::glmmTMB(cbind(deer_present, (n_weeks - deer_present)) ~
                   well_bitumen +
                   (1|array),
                 family = "binomial",
                 data = wtd_dets)

summary(well_bitumen)

well_oil<-glmmTMB::glmmTMB(cbind(deer_present, (n_weeks - deer_present)) ~
                   well_oil +
                   (1|array),
                 family = "binomial",
                 data = wtd_dets)

summary(well_oil)
inactive_well<-glmmTMB::glmmTMB(cbind(deer_present, (n_weeks - deer_present)) ~
                   inactive_well + 
                   (1|array),
                 family = "binomial",
                 data = wtd_dets)

summary(inactive_well)
seismic<-glmmTMB::glmmTMB(cbind(deer_present, (n_weeks - deer_present)) ~
                  seismic +      (1|array),
                 family = "binomial",
                 data = wtd_dets)

summary(seismic)
seismic_3D<-glmmTMB::glmmTMB(cbind(deer_present, (n_weeks - deer_present)) ~
                   seismic_3D +
                   (1|array),
                 family = "binomial",
                 data = wtd_dets)

summary(seismic_3D)
harvest<-glmmTMB::glmmTMB(cbind(deer_present, (n_weeks - deer_present)) ~
                   harvest +
                   (1|array),
                 family = "binomial",
                 data = wtd_dets)

summary(harvest)

pipeline<-glmmTMB::glmmTMB(cbind(deer_present, (n_weeks - deer_present)) ~
                   pipeline +
                   (1|array),
                 family = "binomial",
                 data = wtd_dets)

summary(pipeline)

ms<-model.sel(disturbance_index, roads, well_gas, well_oil, well_bitumen, inactive_well, harvest, pipeline, seismic, seismic_3D,
              rank = "AICc")

ms<- as.data.frame(ms) %>%
  # Add model names as a column
  mutate(model = rownames(ms)) %>%
  # Keep only the columns you care about
  dplyr::select(model, df, logLik, AICc, delta, weight) %>%
  # Optional: arrange by AICc
  arrange(AICc)%>%
  mutate(weight = round(weight, digits = 2))

View(ms)

#Ok well_gas has the most informative and its positive, lets build from there

well_gas<-glmmTMB::glmmTMB(cbind(deer_present, (n_weeks - deer_present)) ~
                   well_gas +
                   (1|array),
                 family = "binomial",
                 data = wtd_dets)

summary(well_gas)


#Snow and snow anomaly?
m1<-glmmTMB::glmmTMB(cbind(deer_present, (n_weeks - deer_present)) ~
                   well_gas + PC1 + PC2 + mean_snow_spatial + snow_anomaly+
                     well_gas*mean_snow_spatial+
                   (1|array),
                 family = "binomial",
                 data = wtd_dets)


summary(m1)


m1<-glmmTMB::glmmTMB(cbind(deer_present, (n_weeks - deer_present)) ~
                   well_gas + PC1 + PC2 + mean_min_temp_spatial + temp_anomaly+
                     well_gas*mean_min_temp_spatial+
                   (1|array),
                 family = "binomial",
                 data = wtd_dets)


summary(m1)

#Can we plot this?




m1<-glmmTMB::glmmTMB(cbind(deer_present, (n_weeks - deer_present)) ~
                   well_gas + PC1 + PC2 + mean_min_temp_spatial + temp_anomaly+
                     well_gas*mean_min_temp_spatial+
                   (1|array),
                 family = "binomial",
                 data = wtd_dets)


summary(m1)



m1<-glmmTMB::glmmTMB(cbind(deer_present, (n_weeks - deer_present)) ~
                   pipeline + PC1 + PC2 + mean_min_temp_spatial + temp_anomaly+
                     pipeline*mean_min_temp_spatial+
                   (1|array),
                 family = "binomial",
                 data = wtd_dets)


summary(m1)



##############################################
#3D seismic has the best predictive effect...but its negative. Strange
#Is there anything that can be done to moderate this?
m1<-glmmTMB::glmmTMB(cbind(deer_present, (n_weeks - deer_present)) ~
                   mean_snow_spatial*well_gas+ lat + broadleaf+
                   (1|array),
                 family = "binomial",
                 data = wtd_dets)
summary(m1)


lowQ  <- quantile(wtd_dets$well_gas, 0.10, na.rm = TRUE)
highQ <- quantile(wtd_dets$well_gas, 0.90, na.rm = TRUE)


lowQ  <- min(wtd_dets$pipeline)
highQ <- max(wtd_dets$pipeline)

pred_spatial <- ggpredict(
  m1,
  terms = c("mean_min_temp_spatial [all]",
            "pipeline [lowQ, highQ]"),
  type = "fe"
)%>%
  rename(mean_min_temp_spatial= x,
         disturbance_quantile = group)


ggplot(pred_spatial, aes(x = mean_min_temp_spatial, y = predicted, colour = disturbance_quantile)) +
  geom_line(size = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = disturbance_quantile),
              alpha = 0.15, colour = NA) +
  labs(x = "Scaled average long term mean min temp @ site", 
       y = "Probability of deer weekly presence"
  ) +
  scale_colour_manual(values = c("#0072B2", "#D55E00"),
                      labels = c("Low gas wells", "High gas wells")) +
  scale_fill_manual(values = c("#0072B2", "#D55E00"),
                    labels = c("Low gas wells", "High gas wells")) +
  theme_classic(base_size = 14)



```



```{r}
weather_variables<-c("mean_min_temp", "mean_min_temp_spatial", "temp_anomaly",
                     "mean_snow", "mean_snow_spatial", "snow_anomaly")

disturbance_variables<-c("disturbance_index", "roads", "active_well", "inactive_well", "seismic", "seismic_3D",
                         "harvest", "pipeline")


interaction_combos <- expand.grid(weather = weather_variables,
                                  disturbance = disturbance_variables,
                                  stringsAsFactors = FALSE)

# Initialize an empty list to store results
results_list <- list()

# Loop through each combination
for (i in seq_len(nrow(interaction_combos))) {
  w <- interaction_combos$weather[i]
  d <- interaction_combos$disturbance[i]
  
  # Build formula dynamically
  formula_str <- paste0("cbind(deer_present, (n_weeks - deer_present)) ~ ",
                        w, " * ", d, " + (1 | array)")
  formula_obj <- as.formula(formula_str)
  
  # Try fitting the model, skip if it fails
  model <- try(glmmTMB::glmmTMB(formula_obj, family = binomial, data = wtd_dets), silent = TRUE)
  if (inherits(model, "try-error")) next
  
  # Tidy the model output
  tidy_mod <- broom.mixed::tidy(model, effects = "fixed")
  
  # Extract interaction term
  interaction_term <- paste0(w, ":", d)
  interaction_row <- tidy_mod %>% filter(term == interaction_term)
  
  if (nrow(interaction_row) > 0) {
    results_list[[length(results_list) + 1]] <- data.frame(
      weather = w,
      disturbance = d,
      estimate = interaction_row$estimate,
      std_error = interaction_row$std.error,
      z_value = interaction_row$statistic,
      p_value = interaction_row$p.value
    )
  }
}

# Combine results
interaction_results <- bind_rows(results_list)

# Arrange for easy viewing
interaction_results <- interaction_results %>%
  arrange(p_value)

interaction_results


#Testing models
A<-glmmTMB::glmmTMB(cbind(deer_present, (n_weeks - deer_present)) ~
                   
                   	
mean_min_temp*active_well + broadleaf
                   
                   +(1|array),
                 family = "binomial",
                 data = wtd_dets)
summary(A)



A<-wtd_dets%>%
  group_by(site)%>%
  summarise(n())

```


Lets do some quick model prep and modeling before lunch break
```{r}



#How do I keep losing lat/long??
wtd_dets<-wtd_dets%>%
  left_join(camop%>%
              dplyr::select(site, lat, long),
            by = "site")

#Lets scale the remaining predictors
wtd_dets<-wtd_dets%>%
  mutate(across(c(mean_snow, mean_snow_spatial, snow_anomaly, mean_min_temp, mean_min_temp_spatial, temp_anomaly, disturbance, broadleaf, lat),
              .fns = ~ as.numeric(scale(.x))))  
         

#I forgot to scale things

#I am sure things are correlated af but I dont care right now
# Select your variables
vars <- wtd_dets %>%
  dplyr::select(mean_snow, mean_snow_spatial, snow_anomaly, mean_min_temp, mean_min_temp_spatial, temp_anomaly, disturbance, broadleaf)

# Compute correlation matrix (use complete.obs to ignore NAs)
cor_matrix <- cor(vars, use = "complete.obs")

# Print the correlation matrix
print(round(cor_matrix, 2))

# Visualize it
corrplot(cor_matrix, method = "color", type = "upper", 
         tl.col = "black", tl.srt = 45, addCoef.col = "black")
######################################################################################
#Who cares lets build - models of varying winter components
mean_snow<-glmmTMB::glmmTMB(cbind(deer_present, (n_weeks - deer_present)) ~
                   disturbance +scale(lat) + broadleaf +
                    mean_snow + 
                   (1|array),
                 family = "binomial",
                 data = wtd_dets)
summary(mean_snow)


mean_snow_spatial<-glmmTMB::glmmTMB(cbind(deer_present, (n_weeks - deer_present)) ~
                   disturbance +scale(lat) + broadleaf +
                    mean_snow_spatial + 
                   (1|array),
                 family = "binomial",
                 data = wtd_dets)
summary(mean_snow_spatial)


snow_anomaly<-glmmTMB::glmmTMB(cbind(deer_present, (n_weeks - deer_present)) ~
                   disturbance +scale(lat) + broadleaf +
                    snow_anomaly + 
                   (1|array),
                 family = "binomial",
                 data = wtd_dets)
summary(snow_anomaly)



mean_min_temp<-glmmTMB::glmmTMB(cbind(deer_present, (n_weeks - deer_present)) ~
                   disturbance +scale(lat) + broadleaf +
                    mean_min_temp + 
                   (1|array),
                 family = "binomial",
                 data = wtd_dets)
summary(mean_min_temp)


mean_min_temp_spatial<-glmmTMB::glmmTMB(cbind(deer_present, (n_weeks - deer_present)) ~
                   disturbance +scale(lat) + broadleaf +
                    mean_min_temp_spatial + 
                   (1|array),
                 family = "binomial",
                 data = wtd_dets)
summary(mean_min_temp_spatial)


temp_anomaly<-glmmTMB::glmmTMB(cbind(deer_present, (n_weeks - deer_present)) ~
                   disturbance +scale(lat) + broadleaf +
                    temp_anomaly + 
                   (1|array),
                 family = "binomial",
                 data = wtd_dets)
summary(temp_anomaly)


mean_min_temp_spatial_int<-glmmTMB::glmmTMB(cbind(deer_present, (n_weeks - deer_present)) ~
                   disturbance +scale(lat) + broadleaf +
                    mean_min_temp_spatial*disturbance + 
                   (1|array),
                 family = "binomial",
                 data = wtd_dets)
summary(mean_min_temp_spatial_int)


library(MuMIn)
ms<-model.sel(mean_snow, mean_snow_spatial, snow_anomaly, mean_min_temp, mean_min_temp_spatial, temp_anomaly,
          rank = "AICc")

ms<- as.data.frame(ms) %>%
  # Add model names as a column
  mutate(model = rownames(ms)) %>%
  # Keep only the columns you care about
  dplyr::select(model, df, logLik, AICc, delta, weight) %>%
  # Optional: arrange by AICc
  arrange(AICc)%>%
  mutate(weight = round(weight, digits = 2))

View(ms)


###########################
lowQ  <- quantile(wtd_dets$disturbance, 0.10, na.rm = TRUE)
highQ <- quantile(wtd_dets$disturbance, 0.90, na.rm = TRUE)

pred_spatial <- ggpredict(
  mean_min_temp_spatial,
  terms = c("mean_min_temp_spatial [all]",
            paste0("disturbance [", round(lowQ, 2), ",", round(highQ, 2), "]")),
  type = "fe"
)%>%
  rename(mean_min_temp = x,
         disturbance_quantile = group)


ggplot(pred_spatial, aes(x = mean_min_temp, y = predicted, colour = disturbance_quantile)) +
  geom_line(size = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = disturbance_quantile),
              alpha = 0.15, colour = NA) +
  labs(
    x = "Scaled Mean Minimum Winter Temperature (Spatial)",
    y = "Predicted Probability of Deer Presence",
    colour = "Disturbance level",
    fill = "Disturbance level",
    title = "Interaction between Spatial Mean Winter Temperature and Disturbance"
  ) +
  scale_colour_manual(values = c("#0072B2", "#D55E00"),
                      labels = c("Low disturbance", "High disturbance")) +
  scale_fill_manual(values = c("#0072B2", "#D55E00"),
                    labels = c("Low disturbance", "High disturbance")) +
  theme_classic(base_size = 14)

```




Preparing the data for preliminary models
```{r}
#Lets scale the variables and then explore correlations
temp<-temp%>%
  mutate(across(
    .cols = c(broadleaf, roads, wells, conventional_seismic, pipeline, mean_min_temp, mean_swe, mean_precip, snow_dif, temp_dif, precip_dif, snow_10_mean),
    .fns = ~ as.numeric(scale(.x)),
    .names = "scale_{.col}"
  ))

#Check for correlations
# Select your variables
vars <- temp %>%
  dplyr::select(scale_broadleaf, scale_roads, scale_wells, scale_conventional_seismic, scale_pipeline, scale_mean_min_temp, scale_mean_swe, scale_mean_precip, snow_dif, temp_dif, precip_dif, snow_10_mean)

# Compute correlation matrix (use complete.obs to ignore NAs)
cor_matrix <- cor(vars, use = "complete.obs")

# Print the correlation matrix
print(round(cor_matrix, 2))

# Visualize it
corrplot(cor_matrix, method = "color", type = "upper", 
         tl.col = "black", tl.srt = 45, addCoef.col = "black")

#Alright precipitation is a bad guy. lets remove it
temp<-temp%>%
  dplyr::select(-c(scale_mean_precip, precip_df)


```


Its all come to down to this. Lets run some models baby
```{r}

#Variance estimates for year were super low, so not including those as a random effect

#global model for adults and young to get started!
m1<-glmmTMB::glmmTMB(cbind(n_adult, (n_weeks-n_adult)) ~ scale_broadleaf +
                   scale_roads + scale_wells + scale_conventional_seismic + scale_pipeline + scale_mean_min_temp + scale_mean_swe +
                   (1|array) + (1|year),
                 family = "binomial",
                 data = temp)
summary(m1)


m1<-glmmTMB::glmmTMB(cbind(n_young, (n_weeks-n_young)) ~ scale_broadleaf +
                   scale_roads + scale_wells + scale_conventional_seismic + scale_pipeline + scale_mean_min_temp + scale_mean_swe +
                   (1|array),
                 family = "binomial",
                 data = temp)
summary(m1)

####################
#interaction terms?
m1<-glmmTMB::glmmTMB(cbind(n_adult, (n_weeks-n_adult)) ~ scale_broadleaf +
                   scale_roads + scale_wells + scale_conventional_seismic + scale_pipeline + scale_mean_min_temp + scale_mean_swe + scale_roads*scale_mean_min_temp +
                   (1|array),
                 family = "binomial",
                 data = temp)
summary(m1)


m1<-glmmTMB::glmmTMB(cbind(n_young, (n_weeks-n_young)) ~ scale_broadleaf +
                   scale_roads + scale_wells + scale_conventional_seismic + scale_pipeline + scale_mean_min_temp + scale_mean_swe + scale_pipeline*scale_mean_min_temp+
                   (1|array),
                 family = "binomial",
                 data = temp)
summary(m1)

###################################
#What about a nice straightforward interaction?
m1<-glmmTMB::glmmTMB(cbind(n_young, (n_weeks-n_young)) ~ scale_broadleaf +
                   scale_wells*scale_mean_swe+
                   (1|array),
                 family = "binomial",
                 data = temp)
summary(m1)


#What if we account for that north south gradient?
#Adding the coordinates back in
temp<-temp%>%
  left_join(camop%>%
  dplyr::select(site, lat, long),
  by = c("site"))

#Ok yea latitude is important for suresies
m1<-glmmTMB::glmmTMB(cbind(n_adult, (n_weeks-n_adult)) ~ scale_broadleaf + lat +
                   (1|array),
                 family = "binomial",
                 data = temp)

summary(m1)


m1<-glmmTMB::glmmTMB(cbind(n_adult, (n_weeks-n_adult)) ~ scale_broadleaf + lat + scale_mean_swe +
                       scale_pipeline+
                   (1|array),
                 family = "binomial",
                 data = temp)

summary(m1)


#Models with the difference stuff
m1<-glmmTMB::glmmTMB(cbind(n_adult, (n_weeks-n_adult)) ~ scale_broadleaf + scale_snow_10_mean +
                       scale_pipeline+ scale_snow_dif+
                   (1|array),
                 family = "binomial",
                 data = temp)

summary(m1)


#Models with the difference stuff
m1<-glmmTMB::glmmTMB(cbind(n_young, (n_weeks-n_young)) ~ scale_broadleaf + scale_snow_10_mean + scale_snow_dif +
                       scale_pipeline+
                   (1|array),
                 family = "binomial",
                 data = temp)

summary(m1)


m1<-glmmTMB::glmmTMB(cbind(n_adult, (n_weeks-n_adult)) ~ scale_broadleaf + scale_snow_10_mean +
                       scale_roads+ scale_snow_dif+
                   (1|array),
                 family = "binomial",
                 data = temp)

summary(m1)


#Models with the difference stuff
m1<-glmmTMB::glmmTMB(cbind(n_young, (n_weeks-n_young)) ~ scale_broadleaf + scale_snow_10_mean + scale_snow_dif +
                       scale_pipeline+
                   (1|array),
                 family = "binomial",
                 data = temp)

summary(m1)


#Global
m1<-glmmTMB::glmmTMB(cbind(n_adult, (n_weeks-n_adult)) ~ scale_broadleaf +
                   scale_roads + scale_wells + scale_conventional_seismic + scale_pipeline + scale_snow_10_mean + scale_snow_dif +
                   (1|array) + (1|year),
                 family = "binomial",
                 data = temp)
summary(m1)

#Global
m1<-glmmTMB::glmmTMB(cbind(n_young, (n_weeks-n_young)) ~ scale_broadleaf +
                   scale_roads + scale_wells + scale_conventional_seismic + scale_pipeline + scale_snow_10_mean + scale_snow_dif +
                   (1|array) + (1|year),
                 family = "binomial",
                 data = temp)
summary(m1)



#Global with interaction
m1_adult<-glmmTMB::glmmTMB(cbind(n_adult, (n_weeks-n_adult)) ~ scale_broadleaf +
                   scale_roads + scale_wells + scale_conventional_seismic + scale_pipeline + scale_snow_10_mean + scale_snow_dif + scale_snow_10_mean*scale_roads + scale_snow_dif*scale_roads+
                   (1|array),
                 family = "binomial",
                 data = temp)
summary(m1)

#Global with interaction
m1_young<-glmmTMB::glmmTMB(cbind(n_young, (n_weeks-n_young)) ~ scale_broadleaf +
                   scale_roads + scale_wells + scale_conventional_seismic + scale_pipeline + scale_snow_10_mean + scale_snow_dif +scale_snow_10_mean*scale_roads + scale_snow_dif*scale_roads+
                   (1|array),
                 family = "binomial",
                 data = temp)
summary(m1)

# -----------------------------
# 1. Predicted probabilities for adult-only model
# -----------------------------
roads_q <- quantile(temp$scale_roads, probs = c(0.25, 0.75), na.rm = TRUE)
low_roads <- roads_q[1]
high_roads <- roads_q[2]


adult_pred_low <- ggpredict(m1_adult, terms = c("scale_snow_10_mean [all]", paste0("scale_roads [", round(low_roads, 2), "]")))
adult_pred_low$road_level <- "Low Roads"

adult_pred_high <- ggpredict(m1_adult, terms = c("scale_snow_10_mean [all]", paste0("scale_roads [", round(high_roads, 2), "]")))
adult_pred_high$road_level <- "High Roads"

adult_pred <- bind_rows(adult_pred_low, adult_pred_high)
adult_pred$group <- "Adult Female"

# -----------------------------
# 3. Predicted probabilities for adult+young model
# -----------------------------
young_pred_low <- ggpredict(m1_young, terms = c("scale_snow_10_mean [all]", paste0("scale_roads [", round(low_roads, 2), "]")))
young_pred_low$road_level <- "Low Roads"

young_pred_high <- ggpredict(m1_young, terms = c("scale_snow_10_mean [all]", paste0("scale_roads [", round(high_roads, 2), "]")))
young_pred_high$road_level <- "High Roads"

young_pred <- bind_rows(young_pred_low, young_pred_high)
young_pred$group <- "Adult + Young"

pred_df <- bind_rows(adult_pred, young_pred)

ggplot(pred_df, aes(x = x, y = predicted, color = road_level)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = road_level), alpha = 0.2, color = NA) +
  facet_wrap(~group) +
  labs(
    x = "Long-term Snow Load (10-year mean, scaled)",
    y = "Predicted Probability of Detection",
    color = "Road Density",
    fill = "Road Density"
  ) +
  scale_color_manual(values = c("blue", "red")) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_minimal(base_size = 14)
```
